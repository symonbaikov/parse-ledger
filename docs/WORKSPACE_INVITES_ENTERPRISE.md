# Enterprise-реализация инвайтов в рабочее пространство

Цель: сделать флоу приглашений безопасным и предсказуемым “как у больших компаний”: принять инвайт может только аутентифицированный пользователь, причём его `email` должен совпадать с `email` в приглашении. Для новых пользователей — стандартный onboarding через регистрацию/логин с сохранением токена приглашения.

## Проблема текущей реализации
- `POST /workspaces/invitations/accept` публичный и позволяет принять инвайт без логина.
- Для существующего пользователя приглашение принимается по email из инвайта без проверки владения email (нет гарантии, что принимающий — владелец почты).

## Требования (что должно быть в итоге)
- Принятие инвайта возможно только после входа (JWT).
- Принимающий пользователь должен иметь `user.email === invitation.email` (в нижнем регистре).
- Токен приглашения не должен давать возможность “захватить” аккаунт/рабочее пространство.
- Onboarding:
  - Если пользователь уже существует → логин → принять инвайт.
  - Если пользователя нет → регистрация с email из инвайта (email фиксируется) → принять инвайт.
- UX:
  - При открытии `/invite/:token` пользователь видит: название workspace, роль, срок действия, что произойдёт после принятия.
  - Если не залогинен — видит кнопки “Войти” и “Зарегистрироваться”, которые возвращают назад на `/invite/:token`.
  - Если залогинен не тем email — понятное сообщение “Вам нужно войти как <email>”.
- Безопасность/аудит:
  - Аудит-лог: отправка инвайта, принятие, отклонение, истечение.
  - Rate limit на проверки/принятие токенов.
  - Возможность отозвать инвайт (необязательно для MVP, но ожидаемо на enterprise-уровне).

## Предлагаемая модель данных
Сущность `workspace_invitations` уже есть. Дальше — уточнения:
- `email` (уже есть) — email приглашённого (нормализованный lower-case).
- `token` (уже есть) — случайный UUID.
- `status` (уже есть): `PENDING | ACCEPTED | EXPIRED` (+ опционально `REVOKED`).
- `expires_at` (уже есть).
- `invited_by_id` (уже есть).
- Опционально:
  - `accepted_by_user_id` (для аудита и расследований; сейчас можно вывести из membership, но явное поле полезнее).
  - `revoked_at`, `revoked_by_id` (если добавляем отзыв).

## API-контракт (предлагаемые изменения)

### 1) Получение данных по приглашению (публично, только read)
`GET /api/v1/workspaces/invitations/:token`

Ответ:
```json
{
  "status": "pending",
  "email": "user@example.com",
  "workspace": { "id": "...", "name": "FinFlow Workspace" },
  "role": "member",
  "expiresAt": "2026-01-20T10:00:00.000Z"
}
```

Правила:
- Если токен не найден/истёк/отозван → `404` или `400` с понятным сообщением (не раскрывать лишние детали).
- Можно скрывать email частично (например `u***@domain.com`) на публичной странице; полный email — только после логина.

### 2) Принятие приглашения (только для авторизованных)
`POST /api/v1/workspaces/invitations/:token/accept`

Guard: JWT обязателен.

Правила:
- Если `currentUser.email !== invitation.email` → `403` + сообщение “Войдите как <email>”.
- Если приглашение `PENDING` и не истекло:
  - добавить membership (если нет)
  - установить `user.workspaceId = invitation.workspaceId` (текущая логика)
  - поставить `invitation.status = ACCEPTED`, `acceptedAt = now()`, опционально `acceptedByUserId = currentUser.id`
- Если пользователь уже участник → вернуть `200` (idempotent) или `409` (по предпочтению), но без ошибок UX.

### 3) Регистрация/логин с возвратом на инвайт
Фронт должен поддержать `next` параметр:
- `/login?next=/invite/<token>`
- `/register?next=/invite/<token>&email=<invitedEmail>`

Важно: email на странице регистрации должен быть:
- предзаполнен и заблокирован для изменения, если пришли через инвайт
- валидирован на совпадение с инвайтом на бекенде (после регистрации пользователь всё равно должен принять инвайт как авторизованный).

## Frontend флоу (App Router)

Страница `GET /invite/[token]`:
1) Делает публичный запрос `GET /workspaces/invitations/:token`.
2) Если не авторизован:
   - показывает данные приглашения + CTA:
     - “Войти” → `/login?next=/invite/<token>`
     - “Зарегистрироваться” → `/register?next=/invite/<token>&email=<invitedEmail>`
3) Если авторизован:
   - если email совпадает → кнопка “Принять приглашение” вызывает `POST /workspaces/invitations/:token/accept`.
   - если email не совпадает → сообщение + кнопка “Войти другим аккаунтом”.
4) После успеха:
   - редирект на приложение (например `/` или `/settings/workspace`) + обновление контекста пользователя.

## Email (Resend + React Email)
- Письмо содержит ссылку вида: `${APP_URL}/invite/<token>`
- В письме желательно указать:
  - workspace name
  - роль
  - срок действия
  - кому отправлено (email, частично замаскированный)

## Безопасность и защита от злоупотреблений
- Токен не должен принимать приглашение без авторизации.
- Token enumeration: UUID достаточно, но всё равно:
  - rate limit на `GET /invitations/:token` (например 30/мин на IP)
  - rate limit на accept (например 10/мин на user)
- Ответы ошибок:
  - на публичном `GET` не раскрывать “существует ли email”, только статус токена.
- Аудит-лог:
  - `WORKSPACE_INVITE_SENT`, `WORKSPACE_INVITE_ACCEPTED`, `WORKSPACE_INVITE_REVOKED`, `WORKSPACE_INVITE_EXPIRED`

## План реализации (пошагово)
1) Backend: добавить `GET /workspaces/invitations/:token` (public, read-only).
2) Backend: заменить текущий `POST /workspaces/invitations/accept` на `POST /workspaces/invitations/:token/accept` (JWT required) и проверить совпадение email.
3) Frontend:
   - обновить `/invite/[token]`: получать данные приглашения, проверять auth, редиректить на login/register с `next`.
   - обновить login/register страницы: поддержать `next` и (опционально) `email` preset.
4) Email шаблон: убедиться, что ссылка ведёт на `/invite/<token>`.
5) Тесты:
   - unit: сервис приглашений (accept) с кейсами email mismatch/expired/already member.
   - e2e/интеграционные: invite→login→accept.
6) Миграции (если добавляем поля acceptedBy/revoked): отдельная миграция.

## Edge cases
- Инвайт истёк → показать CTA “попросить пригласить заново”.
- Пользователь уже в workspace → показать “Вы уже участник”.
- Пользователь залогинен другим email → “Войти другим аккаунтом”.
- Наличие нескольких pending инвайтов на один email в разные workspace — поддерживается.

