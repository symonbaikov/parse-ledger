# Архитектурные правила и ограничения

## Общие принципы

- **Многослойная архитектура** - обязательна, строгое разделение слоёв
- **RESTful API** - только REST, версионирование через `/api/v1`
- **TypeScript** - обязателен для всего проекта
- **Идемпотентность** - все операции должны быть идемпотентными (file_hash, Idempotency-Key)

---

## Frontend

### ✅ Можно использовать:

- **Фреймворки:** React или Next.js
- **UI библиотеки:** Material-UI или Ant Design
- **State management:** Redux Toolkit или Context API (Zustand как альтернатива)
- **HTTP клиент:** axios
- **Роутинг:** встроенный в Next.js или React Router

### ❌ Нельзя использовать:

- Другие фреймворки (Vue, Angular, Svelte)
- Другие UI библиотеки без согласования
- GraphQL (только REST API)
- Прямые запросы к БД из frontend
- WebSockets для основной функциональности (только REST)

### Ограничения:

- Frontend работает **только через REST API**
- Использует **только JWT токены** для авторизации
- Не хранит секреты и токены в открытом виде

---

## Backend

### ✅ Можно использовать:

- **Платформа:** Node.js
- **Фреймворк:** NestJS (предпочтительно) или Express.js
- **ORM/миграции:** TypeORM, Prisma или Knex
- **Валидация:** class-validator, class-transformer
- **Логирование:** Winston или Pino (структурированные JSON логи)

### ❌ Нельзя использовать:

- Другие языки программирования (Python, Go, Java и т.д.)
- Другие фреймворки без согласования
- GraphQL серверы
- NoSQL базы данных как основную БД (MongoDB, Redis как кеш/очереди - можно)

### Ограничения:

- Обязательная модульная архитектура (modules, controllers, services)
- Все endpoints должны быть версионированы через `/api/v1`
- Обязательная валидация всех входных данных
- Обязательное структурированное логирование (JSON формат)

---

## База данных

### ✅ Можно использовать:

- **Основная БД:** PostgreSQL (обязательно)
- **Миграции:** Prisma, TypeORM или Knex
- **Кеш/очереди:** Redis (для BullMQ)

### ❌ Нельзя использовать:

- NoSQL как основную БД (MongoDB, DynamoDB и т.д.)
- Другие SQL БД (MySQL, SQLite) без согласования
- Файловые БД для production

### Ограничения:

- Все изменения схемы только через миграции
- Обязательные индексы для оптимизации запросов
- Обязательное поле `file_hash` в таблице Statement для идемпотентности

---

## Обработка файлов

### ✅ Можно использовать:

- **PDF парсинг:** pdf-parse, pdf-lib, pdf-table-extract
- **Excel/CSV:** xlsx, csv-parser
- **OCR:** Tesseract.js или Google Vision API

### ❌ Нельзя использовать:

- Проприетарные библиотеки без лицензии
- Неподдерживаемые/устаревшие библиотеки

### Ограничения:

- Максимальный размер файла: 10MB
- Время обработки PDF: до 30 секунд
- Параллельная обработка: до 5 файлов одновременно
- Обязательная нормализация чисел (замена запятой на точку, удаление разделителей тысяч)

---

## Интеграции

### ✅ Можно использовать:

- **Google APIs:** Google Sheets API, Google Drive API
- **Telegram:** Telegram Bot API
- **Очереди:** BullMQ с Redis

### ❌ Нельзя использовать:

- Прямые интеграции с БД внешних систем
- Прямые вызовы без retry механизмов
- Интеграции без обработки ошибок

### Ограничения:

- Обязательные retry механизмы для всех внешних API
- Обработка rate limits
- Шифрование токенов доступа (Google, Telegram)
- Обработка сетевых сбоев с экспоненциальной задержкой

---

## Аутентификация и безопасность

### ✅ Можно использовать:

- **JWT:** HS256 или RS256 алгоритмы
- **OAuth 2.0:** для Google интеграции
- **Хеширование:** bcrypt для паролей

### ❌ Нельзя использовать:

- Session-based auth для API (только для веб-интерфейса опционально)
- Хранение паролей в открытом виде
- HTTP без HTTPS в production

### Ограничения:

- Access token: срок действия 1 час
- Refresh token: срок действия 30 дней
- Обязательный rate limiting на `/auth/login` (100/час по IP)
- Только HTTPS в production
- Секреты только в переменных окружения

---

## Фоновые задачи

### ✅ Можно использовать:

- **Очереди:** BullMQ с Redis
- **Планировщики:** node-cron для расписания

### ❌ Нельзя использовать:

- Синхронная обработка больших файлов
- Блокирующие операции в основном потоке

### Ограничения:

- Все тяжёлые операции (парсинг, генерация отчётов) через очереди
- Обязательная обработка ошибок в фоновых задачах
- Логирование всех фоновых операций

---

## Логирование и мониторинг

### ✅ Можно использовать:

- **Логирование:** Winston или Pino (структурированные JSON логи)
- **Трейсинг:** OpenTelemetry / Jaeger (опционально)
- **Метрики:** Prometheus, Grafana (опционально)

### ❌ Нельзя использовать:

- Неструктурированные логи
- Логирование чувствительных данных (пароли, токены)

### Ограничения:

- Обязательный формат логов: JSON
- Обязательные поля: timestamp, level, service, user_id, statement_id, correlation_id, message, details
- Обязательное логирование: загрузка файлов, парсинг, ошибки, генерация отчётов
- Обязательный аудит-лог для действий пользователей

---

## API и версионирование

### ✅ Можно использовать:

- RESTful архитектура
- Версионирование через URL: `/api/v1`

### ❌ Нельзя использовать:

- GraphQL
- RPC протоколы
- Версионирование через заголовки (только URL)

### Ограничения:

- Все endpoints под `/api/v1`
- Обязательная поддержка заголовка `Idempotency-Key` для идемпотентных операций
- Единый формат ошибок: `{ error: { code, message, details } }`
- Обязательные HTTP коды: 200, 201, 204, 400, 401, 403, 404, 422, 429, 500

---

## Развёртывание

### ✅ Можно использовать:

- **Frontend:** Vercel или Netlify
- **Backend:** Render, Railway или AWS
- **БД:** облачный PostgreSQL (AWS RDS, MongoDB Atlas для PostgreSQL)
- **Docker:** опционально

### ❌ Нельзя использовать:

- Shared hosting для production
- Локальные серверы без согласования

### Ограничения:

- Доступность системы: минимум 99.5%
- Обязательное резервное копирование БД
- Обязательные переменные окружения для всех секретов
- Staging окружение перед production

---

## Производительность

### Ограничения:

- Время обработки одного PDF: до 30 секунд
- Параллельная обработка: до 5 файлов одновременно
- Время ответа API: оптимизировать запросы
- Rate limiting:
  - Неавторизованные: 100 запросов/час по IP
  - Авторизованные: 1000 запросов/час

---

## Код и стиль

### ✅ Можно использовать:

- **TypeScript:** обязателен
- **Линтер/форматтер:** Biome
- **Комментарии:** на английском языке

### Ограничения:

- Все коммиты на английском языке
- Все комментарии в коде на английском языке
- Обязательное использование TypeScript (без `any` где возможно)
- Следование принципам SOLID
- Модульная архитектура (легко расширяемая)

---

## Исключения

- Любые отклонения от правил должны быть **согласованы** перед реализацией
- Опциональные технологии (OCR, трейсинг) могут быть добавлены позже
- Новые форматы банковских выписок добавляются через модульную архитектуру без изменения ядра
