# Архитектура системы FinFlow

## Обзор системы

FinFlow — это система автоматической загрузки и обработки банковских выписок, построенная на основе монорепозитория с разделением на backend (NestJS) и frontend (Next.js).

### Технологический стек

- **Backend**: NestJS (Node.js 20), TypeScript, TypeORM, PostgreSQL
- **Frontend**: Next.js 16, React 19, Material-UI, TypeScript
- **База данных**: PostgreSQL 14
- **Кеш/Очереди**: Redis 7
- **Контейнеризация**: Docker, Docker Compose
- **PDF парсинг**: pdfreader (Node.js совместимая библиотека)

---

## Архитектура Backend

### Структура проекта

```
backend/
├── src/
│   ├── main.ts                    # Точка входа приложения
│   ├── app.module.ts              # Корневой модуль
│   ├── config/                    # Конфигурации (БД, multer)
│   ├── common/                    # Общие компоненты
│   │   ├── decorators/            # Кастомные декораторы
│   │   ├── filters/               # Exception filters
│   │   ├── guards/                # Guards (JWT, Throttle)
│   │   ├── interceptors/         # Interceptors (логирование)
│   │   └── utils/                 # Утилиты (file-hash, pdf-parser)
│   ├── entities/                  # TypeORM сущности
│   ├── modules/                  # Бизнес-модули
│   └── types/                    # TypeScript типы
└── Dockerfile                    # Docker образ для production
```

### Многослойная архитектура

Система следует принципам многослойной архитектуры с четким разделением ответственности:

#### 1. Client Layer (API Layer)

- **Контроллеры** (`*.controller.ts`): Обработка HTTP запросов, валидация входных данных через DTO
- **Маршрутизация**: Все endpoints под префиксом `/api/v1`
- **Версионирование**: Через URL path (`/api/v1`)

#### 2. Service/Domain Layer

- **Сервисы** (`*.service.ts`): Бизнес-логика, оркестрация операций
- **Domain логика**: Классификация транзакций, парсинг файлов, обработка данных

#### 3. Data Storage Layer

- **TypeORM Repositories**: Доступ к данным через репозитории
- **Entities**: Сущности базы данных с валидацией
- **Migrations**: Управление схемой БД через миграции

#### 4. Integrations Layer

- **Google Sheets API**: Интеграция с Google Sheets для синхронизации данных
- **Telegram Bot API**: Отправка отчетов (планируется)
- **External APIs**: Обработка внешних интеграций с retry механизмами

#### 5. Background Tasks Layer

- **BullMQ + Redis**: Очереди для асинхронной обработки файлов
- **Job Processors**: Обработчики фоновых задач (парсинг, генерация отчетов)

### Модули Backend

#### Auth Module (`modules/auth/`)

**Ответственность**: Аутентификация и авторизация пользователей

- **JWT стратегии**: Access token (1 час) и Refresh token (30 дней)
- **Guards**:
  - `JwtAuthGuard`: Защита маршрутов (глобальный)
  - `JwtRefreshGuard`: Обновление токенов
  - `ThrottleLoginGuard`: Rate limiting для `/auth/login` (100 запросов/час)
- **Decorators**:
  - `@Public()`: Публичные маршруты без авторизации
  - `@CurrentUser()`: Получение текущего пользователя из токена
- **Password hashing**: bcrypt с salt rounds

**Endpoints**:

- `POST /api/v1/auth/register` - Регистрация пользователя
- `POST /api/v1/auth/login` - Вход в систему
- `POST /api/v1/auth/refresh` - Обновление access token
- `POST /api/v1/auth/logout` - Выход из системы

#### Statements Module (`modules/statements/`)

**Ответственность**: Управление загруженными выписками

- **File Upload**: Multer для загрузки файлов (макс. 10MB)
- **Idempotency**: Проверка дубликатов через `file_hash` (SHA-256) и заголовок `Idempotency-Key`
- **File Validation**: Проверка типа и размера файла
- **Status Management**: Отслеживание статусов обработки (uploaded → processing → parsed → validated → completed)

**Endpoints**:

- `POST /api/v1/statements/upload` - Загрузка выписки
- `GET /api/v1/statements` - Список выписок пользователя
- `GET /api/v1/statements/:id` - Детали выписки
- `DELETE /api/v1/statements/:id` - Удаление выписки

#### Parsing Module (`modules/parsing/`)

**Ответственность**: Парсинг банковских выписок из различных форматов

**Архитектура парсеров**:

- **Base Parser** (`base.parser.ts`): Абстрактный класс с общими методами
- **Parser Factory** (`parser-factory.service.ts`): Выбор подходящего парсера
- **Statement Processing** (`statement-processing.service.ts`): Оркестрация процесса парсинга

**Поддерживаемые форматы**:

1. **PDF** (через `pdfreader`):

   - `BerekeNewParser`: Новый формат Bereke Bank (KZ47914042204KZ039LY)
   - `BerekeOldParser`: Старый формат Bereke Bank (KZ17722S000023921191)
   - Автоматическое определение формата по содержимому файла

2. **Excel** (`excel.parser.ts`):

   - Поддержка XLS и XLSX через библиотеку `xlsx`
   - Автоматическое определение структуры таблицы

3. **CSV** (`csv.parser.ts`):
   - Автоматическое определение разделителей (запятая, точка с запятой, табуляция)
   - Обработка различных кодировок

**Процесс парсинга**:

1. Определение типа файла и банка
2. Выбор подходящего парсера через Factory
3. Извлечение метаданных (номер счета, период, балансы)
4. Парсинг транзакций из таблицы
5. Нормализация данных (даты, числа)
6. Сохранение транзакций в БД
7. Автоматическая классификация транзакций

**Утилиты**:

- `pdf-parser.util.ts`: Извлечение текста из PDF с группировкой по строкам
- `number-normalizer.util.ts`: Нормализация чисел (замена запятой на точку, удаление разделителей)
- `file-hash.util.ts`: Вычисление SHA-256 хеша файла для идемпотентности

#### Classification Module (`modules/classification/`)

**Ответственность**: Автоматическая классификация транзакций

**Механизм классификации**:

1. **Определение типа транзакции**: EXPENSE (дебет) или INCOME (кредит)
2. **Применение правил классификации**:
   - Правила с приоритетами
   - Условия по полям: `counterpartyName`, `counterpartyBin`, `paymentPurpose`, `amount`
   - Результаты: назначение категории, филиала, кошелька
3. **Исторические данные**: Использование предыдущих классификаций для похожих транзакций
4. **Автоматическое назначение**: Категория, филиал, кошелек на основе правил

**Интерфейсы**:

- `ClassificationRule`: Правило классификации с условиями и результатами
- `ClassificationCondition`: Условие для сопоставления транзакции
- `ClassificationResult`: Результат классификации (categoryId, branchId, walletId)

#### Categories Module (`modules/categories/`)

**Ответственность**: Управление категориями транзакций

**CRUD операции**:

- Создание, чтение, обновление, удаление категорий
- Поддержка типов категорий: INCOME, EXPENSE, TRANSFER
- Иерархическая структура (parent-child отношения)

**Endpoints**:

- `POST /api/v1/categories` - Создание категории
- `GET /api/v1/categories` - Список категорий
- `GET /api/v1/categories/:id` - Детали категории
- `PUT /api/v1/categories/:id` - Обновление категории
- `DELETE /api/v1/categories/:id` - Удаление категории

#### Branches Module (`modules/branches/`)

**Ответственность**: Управление филиалами/проектами

**CRUD операции**: Полный набор операций для управления филиалами

**Endpoints**:

- `POST /api/v1/branches` - Создание филиала
- `GET /api/v1/branches` - Список филиалов
- `GET /api/v1/branches/:id` - Детали филиала
- `PUT /api/v1/branches/:id` - Обновление филиала
- `DELETE /api/v1/branches/:id` - Удаление филиала

#### Wallets Module (`modules/wallets/`)

**Ответственность**: Управление кошельками/счетами

**CRUD операции**: Полный набор операций для управления кошельками

**Endpoints**:

- `POST /api/v1/wallets` - Создание кошелька
- `GET /api/v1/wallets` - Список кошельков
- `GET /api/v1/wallets/:id` - Детали кошелька
- `PUT /api/v1/wallets/:id` - Обновление кошелька
- `DELETE /api/v1/wallets/:id` - Удаление кошелька

#### Transactions Module (`modules/transactions/`)

**Ответственность**: Управление транзакциями

**Функциональность**:

- Просмотр транзакций с фильтрацией и пагинацией
- Редактирование отдельных транзакций
- Массовое обновление транзакций (bulk update)
- Удаление транзакций

**Endpoints**:

- `GET /api/v1/transactions` - Список транзакций (с фильтрами)
- `GET /api/v1/transactions/:id` - Детали транзакции
- `PUT /api/v1/transactions/:id` - Обновление транзакции
- `POST /api/v1/transactions/bulk-update` - Массовое обновление
- `DELETE /api/v1/transactions/:id` - Удаление транзакции

#### Google Sheets Module (`modules/google-sheets/`)

**Ответственность**: Интеграция с Google Sheets

**Функциональность**:

- Подключение Google Sheets через OAuth 2.0
- Синхронизация данных транзакций в Google Sheets
- Управление подключенными таблицами

**Endpoints**:

- `GET /api/v1/google-sheets` - Список подключенных таблиц
- `GET /api/v1/google-sheets/:id` - Детали таблицы
- `PUT /api/v1/google-sheets/:id/sync` - Синхронизация данных
- `DELETE /api/v1/google-sheets/:id` - Отключение таблицы

#### Users Module (`modules/users/`)

**Ответственность**: Управление пользователями

**Endpoints**:

- `GET /api/v1/users/me` - Текущий пользователь
- `PUT /api/v1/users/me` - Обновление профиля

#### Storage Module (`modules/storage/`)

**Ответственность**: Управление файлами, шаринг и права доступа

**Функциональность**:

- Просмотр всех файлов в хранилище (owned + shared)
- Детальная информация о файле с транзакциями
- Скачивание файлов
- Создание и управление shared links (публичными ссылками)
- Управление правами доступа к файлам (permissions)
- Публичный доступ к файлам по ссылке (с опциональной защитой паролем)

**Endpoints**:

- `GET /api/v1/storage/files` - Список всех файлов (owned + shared)
- `GET /api/v1/storage/files/:id` - Детали файла с транзакциями
- `GET /api/v1/storage/files/:id/download` - Скачать файл
- `POST /api/v1/storage/files/:id/share` - Создать shared link
- `GET /api/v1/storage/files/:id/shares` - Получить shared links
- `PUT /api/v1/storage/shares/:id` - Обновить shared link
- `DELETE /api/v1/storage/shares/:id` - Удалить shared link
- `GET /api/v1/storage/shared/:token` - Публичный доступ к файлу (no auth)
- `GET /api/v1/storage/shared/:token/download` - Скачать файл по shared link (no auth)
- `POST /api/v1/storage/files/:id/permissions` - Предоставить права доступа
- `GET /api/v1/storage/files/:id/permissions` - Получить права доступа
- `PUT /api/v1/storage/permissions/:id` - Обновить права доступа
- `DELETE /api/v1/storage/permissions/:id` - Отозвать права доступа

**Типы прав доступа (FilePermissionType)**:

- `OWNER` - Владелец (все права)
- `EDITOR` - Редактор (просмотр, скачивание, редактирование)
- `VIEWER` - Просмотр
- `DOWNLOADER` - Просмотр и скачивание

**Уровни доступа для shared links (SharePermissionLevel)**:

- `VIEW` - Только просмотр метаданных
- `DOWNLOAD` - Просмотр и скачивание файла
- `EDIT` - Полный доступ к файлу и транзакциям

**Особенности**:

- Shared links с опциональным сроком действия
- Защита паролем для shared links
- Отслеживание количества обращений к shared links
- Автоматическая проверка прав доступа
- Поддержка анонимного доступа к shared links

### Сущности базы данных (Entities)

#### User

- `id`: UUID (первичный ключ)
- `email`: Уникальный email
- `password`: Хешированный пароль (bcrypt)
- `role`: Роль пользователя (USER, ADMIN)
- `createdAt`, `updatedAt`: Временные метки

#### Statement

- `id`: UUID
- `userId`: Связь с пользователем
- `fileName`, `filePath`, `fileType`, `fileSize`, `fileHash`: Метаданные файла
- `bankName`: Банк (BEREKE_NEW, BEREKE_OLD, KASPI, OTHER)
- `status`: Статус обработки (UPLOADED, PROCESSING, PARSED, VALIDATED, COMPLETED, ERROR)
- `googleSheetId`: Связь с Google Sheet
- `metadata`: JSON с метаданными выписки (номер счета, период, балансы)

#### Transaction

- `id`: UUID
- `statementId`: Связь с выпиской
- `transactionDate`: Дата операции
- `documentNumber`: Номер документа
- `counterpartyName`, `counterpartyBin`, `counterpartyAccount`, `counterpartyBank`: Данные контрагента
- `debit`, `credit`, `amount`: Суммы операции
- `currency`: Валюта (по умолчанию KZT)
- `paymentPurpose`: Назначение платежа
- `transactionType`: Тип (INCOME, EXPENSE, TRANSFER)
- `categoryId`, `branchId`, `walletId`: Классификация транзакции

#### Category

- `id`: UUID
- `name`: Название категории
- `type`: Тип (INCOME, EXPENSE, TRANSFER)
- `parentId`: Родительская категория (для иерархии)
- `userId`: Владелец категории

#### Branch

- `id`: UUID
- `name`: Название филиала/проекта
- `description`: Описание
- `userId`: Владелец филиала

#### Wallet

- `id`: UUID
- `name`: Название кошелька/счета
- `description`: Описание
- `userId`: Владелец кошелька

#### GoogleSheet

- `id`: UUID
- `userId`: Владелец таблицы
- `sheetId`: ID Google Sheet
- `name`: Название таблицы
- `accessToken`, `refreshToken`: Токены доступа (зашифрованы)

#### ParsingRule

- `id`: UUID
- `userId`: Владелец правила
- `name`: Название правила
- `conditions`: JSON с условиями парсинга
- `priority`: Приоритет правила

#### AuditLog

- `id`: UUID
- `userId`: Пользователь
- `action`: Действие
- `entityType`, `entityId`: Сущность
- `details`: JSON с деталями действия
- `ipAddress`: IP адрес
- `userAgent`: User Agent
- `createdAt`: Временная метка

#### SharedLink

- `id`: UUID
- `statementId`: Связь с выпиской
- `userId`: Владелец ссылки
- `token`: Уникальный токен (64 символа)
- `permission`: Уровень доступа (VIEW, DOWNLOAD, EDIT)
- `expiresAt`: Дата истечения (опционально)
- `password`: Хешированный пароль (опционально)
- `status`: Статус (ACTIVE, EXPIRED, REVOKED)
- `accessCount`: Количество обращений
- `lastAccessedAt`: Дата последнего обращения
- `allowAnonymous`: Разрешить анонимный доступ
- `description`: Описание ссылки

#### FilePermission

- `id`: UUID
- `statementId`: Связь с выпиской
- `userId`: Пользователь с правами
- `grantedById`: Кто предоставил права
- `permissionType`: Тип прав (OWNER, EDITOR, VIEWER, DOWNLOADER)
- `canReshare`: Может ли пользователь делиться с другими
- `expiresAt`: Дата истечения прав (опционально)
- `isActive`: Активны ли права

### Глобальные компоненты

#### Exception Filter (`HttpExceptionFilter`)

- Обработка всех исключений
- Единый формат ошибок: `{ error: { code, message, details } }`
- Логирование ошибок

#### Logging Interceptor (`LoggingInterceptor`)

- Структурированное логирование всех запросов
- Формат: JSON с полями `timestamp`, `level`, `method`, `url`, `statusCode`, `responseTime`, `correlationId`
- Корреляционные ID для трейсинга запросов

#### JWT Auth Guard (`JwtAuthGuard`)

- Глобальная защита всех маршрутов
- Проверка JWT токена
- Извлечение пользователя из токена
- Исключения через декоратор `@Public()`

#### Throttler Guard (`ThrottlerGuard`)

- Rate limiting: 100 запросов/минуту для авторизованных пользователей
- Специальный лимит для `/auth/login`: 100 запросов/час по IP

### Конфигурация

#### Database Config (`config/database.config.ts`)

- Настройка TypeORM подключения к PostgreSQL
- Поддержка миграций
- Настройка пула соединений

#### Multer Config (`config/multer.config.ts`)

- Настройка загрузки файлов
- Хранение в `./uploads`
- Генерация уникальных имен файлов через UUID
- Лимит размера: 10MB

---

## Архитектура Frontend

### Структура проекта

```
frontend/
├── app/
│   ├── layout.tsx                 # Корневой layout
│   ├── page.tsx                   # Главная страница
│   ├── providers.tsx              # Провайдеры (ThemeProvider)
│   ├── middleware.ts              # Next.js middleware для защиты маршрутов
│   ├── (auth)/                    # Группа маршрутов авторизации
│   │   ├── login/page.tsx
│   │   └── register/page.tsx
│   ├── upload/page.tsx           # Страница загрузки файлов
│   ├── statements/                # Страницы выписок
│   │   ├── page.tsx              # Список выписок
│   │   └── [id]/edit/page.tsx    # Редактирование транзакций
│   ├── categories/page.tsx       # Управление категориями
│   ├── components/               # React компоненты
│   ├── hooks/                    # Custom hooks
│   │   └── useAuth.ts           # Хук для работы с авторизацией
│   ├── lib/                      # Утилиты и библиотеки
│   │   └── api.ts               # Axios клиент с interceptors
│   ├── store/                    # State management (если используется)
│   ├── utils/                    # Утилиты
│   └── theme.ts                  # Material-UI тема
└── Dockerfile                    # Docker образ для production
```

### Технологии Frontend

- **Next.js 16**: React фреймворк с App Router
- **React 19**: UI библиотека
- **Material-UI (MUI)**: Компоненты интерфейса
- **TypeScript**: Типизация
- **Axios**: HTTP клиент с interceptors для токенов
- **Tailwind CSS**: Утилитарные стили (опционально)

### Архитектурные паттерны

#### 1. Client-Server разделение

- Frontend работает только через REST API
- Нет прямого доступа к БД
- Все данные через `/api/v1` endpoints

#### 2. Protected Routes

- Middleware для проверки авторизации
- Редирект на `/login` для неавторизованных пользователей
- Сохранение токенов в localStorage

#### 3. API Client (`lib/api.ts`)

- Axios instance с базовым URL
- Request interceptor: добавление JWT токена
- Response interceptor: обработка ошибок, обновление токенов

#### 4. Custom Hooks

- `useAuth`: Управление состоянием авторизации
- Работа с токенами (сохранение, обновление, удаление)

### Страницы Frontend

#### Главная страница (`page.tsx`)

- Приветствие и навигация
- Ссылки на регистрацию и вход

#### Страница загрузки (`upload/page.tsx`)

- Drag-and-drop область для файлов
- Выбор Google Sheet
- Выбор филиала/кошелька
- Индикация прогресса загрузки
- Валидация файлов на клиенте

#### Страница выписок (`statements/page.tsx`)

- Список загруженных выписок
- Фильтрация и поиск
- Статусы обработки
- Переход к редактированию транзакций

#### Страница редактирования транзакций (`statements/[id]/edit/page.tsx`)

- Таблица транзакций из выписки
- Фильтрация и пагинация
- Редактирование отдельных транзакций
- Массовое обновление транзакций
- Назначение категорий, филиалов, кошельков

#### Страница категорий (`categories/page.tsx`)

- CRUD операции для категорий
- Иерархическое отображение
- Фильтрация по типу (INCOME, EXPENSE)

#### Страница хранилища (`storage/page.tsx`)

- Список всех файлов (owned + shared)
- Поиск по названию, банку, номеру счета
- Просмотр статусов и прав доступа
- Быстрые действия: просмотр, скачивание, шаринг

#### Страница детального просмотра файла (`storage/[id]/page.tsx`)

- Вкладки: Транзакции, Ссылки, Права доступа
- Просмотр всех транзакций файла
- Создание и управление shared links
- Управление правами доступа пользователей
- Скачивание файла

#### Страница публичного доступа (`shared/[token]/page.tsx`)

- Публичный доступ к файлу по токену (no auth required)
- Ввод пароля если требуется
- Просмотр метаданных файла
- Просмотр транзакций (если разрешено)
- Скачивание файла (если разрешено)

### Компоненты

#### TransactionsView

- Отображение списка транзакций
- Поиск по транзакциям
- Пагинация
- Форматирование дат и сумм

#### ShareDialog

- Создание новой shared link
- Настройка уровня доступа
- Установка срока действия
- Защита паролем
- Список существующих ссылок
- Копирование ссылки в буфер обмена
- Удаление ссылок

#### PermissionsPanel

- Предоставление прав доступа пользователям
- Таблица с текущими правами
- Редактирование прав
- Отзыв прав доступа
- Настройка срока действия прав

---

## База данных

### PostgreSQL

**Версия**: PostgreSQL 14

**Особенности**:

- Все таблицы с UUID первичными ключами
- Индексы на часто используемых полях (`userId`, `statementId`, `categoryId`)
- Внешние ключи для целостности данных
- JSON поля для гибкого хранения метаданных

### Миграции

- Управление через TypeORM migrations
- Версионирование схемы БД
- Автоматическое применение при развертывании

### Индексы

- `statements.userId` - для быстрого поиска выписок пользователя
- `transactions.statementId` - для связи транзакций с выписками
- `transactions.userId` - для фильтрации транзакций пользователя
- `statements.fileHash` - для проверки дубликатов (уникальный индекс)

---

## Интеграции

### Google Sheets API

**Протокол**: OAuth 2.0

**Функциональность**:

- Подключение Google Sheets через OAuth flow
- Сохранение токенов доступа (зашифрованы)
- Синхронизация транзакций в Google Sheets
- Обновление токенов через refresh token

**Безопасность**:

- Токены хранятся в зашифрованном виде
- Использование refresh token для обновления access token

### Telegram Bot API (планируется)

**Функциональность**:

- Отправка финансовых отчетов в Telegram
- Уведомления о завершении обработки файлов
- Команды бота для управления системой

---

## Обработка файлов

### Процесс обработки

1. **Загрузка файла**:

   - Валидация типа и размера (макс. 10MB)
   - Вычисление SHA-256 хеша
   - Проверка дубликатов по `fileHash`
   - Сохранение файла в `uploads/`

2. **Парсинг файла**:

   - Определение типа файла (PDF, Excel, CSV)
   - Определение банка и формата
   - Выбор подходящего парсера
   - Извлечение метаданных и транзакций
   - Нормализация данных

3. **Сохранение данных**:

   - Создание записи Statement
   - Создание записей Transaction
   - Автоматическая классификация транзакций

4. **Синхронизация**:
   - Отправка данных в Google Sheets (если подключен)
   - Обновление статуса Statement

### Поддерживаемые форматы

#### PDF

- **Библиотека**: `pdfreader` (Node.js совместимая)
- **Форматы**: Bereke Bank (новый и старый), Kaspi Bank (планируется)
- **Особенности**: Автоматическое определение формата, извлечение текста с группировкой по строкам

#### Excel

- **Библиотека**: `xlsx`
- **Форматы**: XLS, XLSX
- **Особенности**: Автоматическое определение структуры таблицы

#### CSV

- **Библиотека**: `csv-parser`
- **Особенности**: Автоматическое определение разделителей (запятая, точка с запятой, табуляция)

### Нормализация данных

- **Числа**: Замена запятой на точку, удаление разделителей тысяч
- **Даты**: Парсинг различных форматов (DD.MM.YYYY, YYYY-MM-DD)
- **Текст**: Тримминг пробелов, нормализация кодировок

---

## Безопасность

### Аутентификация

- **JWT токены**: Access token (1 час) и Refresh token (30 дней)
- **Алгоритм**: HS256 или RS256
- **Хранение**: Access token в памяти, Refresh token в httpOnly cookie (опционально)
- **Обновление**: Автоматическое обновление через `/auth/refresh`

### Авторизация

- **Guards**: Глобальная защита всех маршрутов через `JwtAuthGuard`
- **Роли**: USER, ADMIN (расширяемо)
- **Публичные маршруты**: Через декоратор `@Public()`

### Защита данных

- **Пароли**: Хеширование через bcrypt
- **Токены**: Хранение в переменных окружения
- **Файлы**: Проверка типов и размеров, изоляция в `uploads/`
- **SQL Injection**: Защита через TypeORM параметризованные запросы
- **XSS**: Валидация и санитизация входных данных

### Rate Limiting

- **Общий лимит**: 100 запросов/минуту для авторизованных пользователей
- **Login endpoint**: 100 запросов/час по IP адресу
- **Реализация**: `@nestjs/throttler`

---

## Логирование и мониторинг

### Структурированное логирование

**Формат**: JSON

**Поля логов**:

- `timestamp`: Временная метка
- `level`: Уровень (info, warn, error)
- `service`: Название сервиса/модуля
- `correlationId`: ID для трейсинга запросов
- `userId`: ID пользователя (если авторизован)
- `statementId`: ID выписки (если применимо)
- `message`: Сообщение
- `details`: Дополнительные детали (JSON)

### События для логирования

- Загрузка файлов
- Парсинг файлов (начало, завершение, ошибки)
- Классификация транзакций
- Генерация отчетов
- Ошибки API
- Действия пользователей (для аудита)

### Audit Log

- Все действия пользователей записываются в `AuditLog`
- Поля: `userId`, `action`, `entityType`, `entityId`, `details`, `ipAddress`, `userAgent`

---

## Docker и развертывание

### Docker Compose

**Сервисы**:

1. **PostgreSQL**: База данных (порт 5432)
2. **Redis**: Кеш и очереди (порт 6379)
3. **Backend**: NestJS приложение (порт 3001)
4. **Frontend**: Next.js приложение (порт 3000)

**Volumes**:

- `postgres_data`: Данные PostgreSQL
- `redis_data`: Данные Redis
- `backend_uploads`: Загруженные файлы

**Networks**:

- `finflow-network`: Bridge сеть для связи между сервисами

### Dockerfile Backend

**Multi-stage build**:

1. **Builder stage**: Установка зависимостей и сборка TypeScript
2. **Production stage**: Минимальный образ с только production зависимостями

**Особенности**:

- Node.js 20 Alpine (минимальный размер)
- Health check для проверки работоспособности
- Создание директории `uploads/`

### Dockerfile Frontend

**Multi-stage build**:

1. **Builder stage**: Сборка Next.js приложения
2. **Production stage**: Запуск production сервера

**Особенности**:

- Node.js 20 Alpine
- Передача переменных окружения через build args
- Оптимизация для production

### Переменные окружения

**Backend**:

- `DATABASE_URL`: Строка подключения к PostgreSQL
- `REDIS_HOST`, `REDIS_PORT`: Параметры Redis
- `JWT_SECRET`, `JWT_REFRESH_SECRET`: Секреты для JWT
- `JWT_EXPIRES_IN`, `JWT_REFRESH_EXPIRES_IN`: Время жизни токенов
- `FRONTEND_URL`: URL фронтенда для CORS
- `LOG_LEVEL`: Уровень логирования

**Frontend**:

- `NEXT_PUBLIC_API_URL`: URL backend API

---

## Производительность и масштабирование

### Оптимизации

- **Индексы БД**: На часто используемых полях
- **Connection Pooling**: Настройка пула соединений TypeORM
- **Асинхронная обработка**: Тяжелые операции через очереди
- **Кеширование**: Redis для кеширования часто запрашиваемых данных

### Ограничения

- **Размер файла**: Максимум 10MB
- **Время обработки PDF**: До 30 секунд
- **Параллельная обработка**: До 5 файлов одновременно
- **Rate Limiting**: 100 запросов/минуту

---

## Система хранилища и шаринга

### Архитектура хранилища

Система хранилища обеспечивает централизованное управление файлами с возможностью:

1. **Управление файлами**:
   - Просмотр всех файлов пользователя (owned + shared)
   - Детальная информация о файле с транзакциями
   - Скачивание оригинальных файлов
   - Просмотр результатов парсинга

2. **Публичный шаринг (Shared Links)**:
   - Создание публичных ссылок на файлы
   - Настройка уровня доступа (VIEW, DOWNLOAD, EDIT)
   - Защита паролем (опционально)
   - Ограничение срока действия
   - Отслеживание количества обращений

3. **Права доступа (Permissions)**:
   - Предоставление прав конкретным пользователям
   - Типы прав: OWNER, EDITOR, VIEWER, DOWNLOADER
   - Возможность разрешить пользователю делиться с другими (canReshare)
   - Ограничение срока действия прав
   - Отзыв прав доступа

### Безопасность хранилища

1. **Проверка доступа**:
   - Все операции проверяют права пользователя
   - Владелец имеет полные права
   - Другие пользователи проверяются через FilePermission
   - Автоматическая проверка истечения прав

2. **Shared Links**:
   - Уникальные 64-символьные токены
   - Опциональная защита паролем (bcrypt)
   - Автоматическое истечение по дате
   - Отслеживание статуса (ACTIVE, EXPIRED, REVOKED)

3. **Анонимный доступ**:
   - Публичные endpoints не требуют авторизации
   - Проверка токена и пароля
   - Ограничение доступа на основе permission level

### Workflow шаринга

#### Создание Shared Link:

1. Пользователь создает shared link для файла
2. Система генерирует уникальный токен
3. Устанавливаются параметры (permission, expiry, password)
4. Ссылка сохраняется в базу
5. Пользователь получает URL для шаринга

#### Доступ по Shared Link:

1. Получатель открывает публичную ссылку
2. Система проверяет токен
3. Проверяется статус ссылки (active/expired/revoked)
4. Если требуется, запрашивается пароль
5. Предоставляется доступ согласно permission level
6. Обновляется счетчик обращений

#### Управление правами:

1. Владелец файла предоставляет права пользователю
2. Указывается тип прав и срок действия
3. Права сохраняются в FilePermission
4. При каждом обращении проверяются права и срок действия
5. Владелец может изменить или отозвать права

### Масштабирование

- **Горизонтальное**: Возможность запуска нескольких инстансов backend
- **Вертикальное**: Увеличение ресурсов контейнеров
- **База данных**: Репликация и шардирование (при необходимости)

---

## Расширяемость

### Добавление новых форматов банков

1. Создать новый парсер, наследующий `BaseParser`
2. Реализовать методы `canParse()` и `parse()`
3. Зарегистрировать парсер в `ParserFactoryService`
4. Система автоматически определит и использует новый парсер

### Добавление новых интеграций

1. Создать новый модуль в `modules/`
2. Реализовать сервис с бизнес-логикой
3. Добавить контроллер с endpoints
4. Зарегистрировать модуль в `AppModule`

### Добавление новых полей в транзакции

1. Обновить entity `Transaction`
2. Создать миграцию для изменения схемы БД
3. Обновить парсеры для извлечения новых полей
4. Обновить DTO и валидацию

---

## Идемпотентность

### Механизмы идемпотентности

1. **File Hash**: SHA-256 хеш файла для предотвращения дубликатов
2. **Idempotency-Key**: HTTP заголовок для идемпотентных операций
3. **Unique Constraints**: Уникальные индексы в БД (`fileHash`)

### Применение

- **Загрузка файлов**: Проверка `fileHash` перед сохранением
- **Генерация отчетов**: Использование `Idempotency-Key`
- **Webhooks**: Идемпотентная обработка входящих запросов

---

## Заключение

Архитектура FinFlow построена на принципах:

- **Модульность**: Четкое разделение на модули с определенной ответственностью
- **Расширяемость**: Легкое добавление новых форматов и интеграций
- **Безопасность**: Многоуровневая защита данных и API, система прав доступа
- **Производительность**: Оптимизация запросов и асинхронная обработка
- **Надежность**: Обработка ошибок, логирование, идемпотентность
- **Коллаборация**: Система хранилища с шарингом и управлением правами доступа

Система готова к production использованию и легко расширяется под новые требования.

## Новые возможности: Хранилище и шаринг

Добавленная функциональность хранилища превращает FinFlow в полноценную систему управления финансовыми документами с возможностями:

- **Централизованное хранилище**: Все файлы в одном месте с удобным поиском
- **Публичный шаринг**: Делитесь файлами с кем угодно через защищенные ссылки
- **Гранулярные права**: Точный контроль того, кто и что может делать с файлами
- **Аудит доступа**: Отслеживание всех обращений к файлам
- **Безопасность**: Защита паролем, истечение ссылок, отзыв доступа




