# Улучшения, которые можно сделать “прямо сейчас”

Ниже — практичный список быстрых улучшений (без больших архитектурных переписываний), которые повышают надёжность, поддержку и скорость разработки.

## Надёжность и стабильность
- Добавить очереди для тяжёлых задач: обработка выписок, AI-реконсиляция, экспорт отчётов, синхронизация в Google Sheets (BullMQ/Redis).
- Ввести ретраи с backoff + дедупликацию задач (idempotency) для фоновых процессов.
- Ограничить параллелизм парсинга на инстанс (конкурентность воркера, rate limit на AI).
- Добавить таймауты на внешние вызовы (Google APIs, Resend, Telegram, AI) и безопасные фолбэки.
- Сделать “graceful degradation”: если AI/табличный экстрактор упал — сохранять частичный результат и лог причину.
- Добавить “circuit breaker” на AI и внешние интеграции при частых ошибках.

## Файлы и хранение
- Вынести работу с файлами в единый слой/сервис (например `FileStorageService`) вместо дублирования логики в Statements/Storage.
- Утвердить стратегию хранения: S3/MinIO для production (вместо локального диска/ephemeral FS).
- Ввести политику ретеншна: хранить оригиналы N дней/месяцев, либо только hash+метаданные; опционально шифровать файлы at-rest.
- Добавить в UI/бэке “индикатор доступности файла” (есть на диске/в БД/утрачен) и понятное сообщение пользователю.

## Наблюдаемость (observability)
- Структурные логи (JSON) + корреляция запросов (`requestId`/`traceId`), прокидывать в фронт/ответы.
- Метрики (Prometheus): время парсинга, размер файлов, количество ошибок по банкам, % успешности, задержка очереди.
- Sentry/OTel трассировка: ошибки + performance traces для критичных эндпоинтов.
- Healthchecks: расширить (DB, Redis, внешние интеграции), readiness/liveness для контейнеров.

## Безопасность и соответствие
- Перенести все секреты из репо и локальных `.env` в секрет-менеджер (Railway vars/Vault/etc), запретить коммит `.env`.
- Проверить JWT: ротация секретов, аудит refresh-токенов, blacklist/rotation при компрометации.
- Ужесточить контроль доступа в модулях (workspace/permissions): централизованный guard/политики.
- Rate-limit на чувствительные endpoints (логин/инвайты/шары) и captcha при необходимости.
- Добавить аудит-лог на действия: share link, revoke/grant permissions, workspace invites, download/view.

## Тестирование и качество
- Добавить тесты на критичные сценарии:
  - upload → parse → view/download/preview;
  - reprocess при отсутствии файла на диске;
  - workspace invite → accept;
  - share link доступ/пароль/expiry;
  - permissions матрица (owner/admin/member/viewer).
- Добавить интеграционные тесты (Nest + Testcontainers/Postgres) хотя бы для 2–3 “happy paths”.
- Подключить CI (GitHub Actions): lint + test + build, проверка миграций.
- Включить форматирование/линт без `--fix` в CI, чтобы не скрывать проблемы.

## Миграции и данные
- Ввести правило: “миграция на каждое изменение схемы”, проверка `migrationsRun` в prod окружении.
- Добавить индексы и ограничения, где это критично (частые выборки по workspaceId/userId/status/createdAt).
- Добавить soft-delete или статус “archived” для важных сущностей (выписки/ссылки) вместо полного удаления.
- Нормализовать схему для storage/sharing (явная модель “File” vs “Statement”, если это расходится).

## Архитектура и границы домена
- Разделить “командные” и “читающие” сценарии: сервисы/handlers для use-cases, тонкие контроллеры.
- Вынести парсеры в отдельный модуль с контрактом (интерфейс, unit tests per bank).
- Добавить “feature flags” для рискованных функций (AI reconciliation, auto-sync, auto-category).
- Унифицировать ошибки (единый формат, коды, локализация сообщений).

## Производительность и UX
- Кэшировать результаты тяжёлых операций (например, preview/детали) с инвалидацией.
- Пагинация/виртуализация для больших таблиц на фронте, лимиты на выдачи API.
- Поддержка “прогресса” обработки (websocket/SSE/polling с ETA), чтобы пользователь видел статус.

## Документация и эксплуатация
- Добавить `RUNBOOK.md`: типовые инциденты (файл потерян, парсер падает, AI недоступен), команды и решения.
- Добавить `SECURITY.md`: политика секретов, доступы, ротация ключей, ответственные.
- Добавить `DEPLOYMENT.md`: переменные окружения, миграции, бэкапы, мониторинг.

## Быстрые “low-effort” правки (1–2 дня)
- Централизовать MIME/Content-Disposition и стриминг файлов (один helper, используется в Statements/Storage/Shared).
- Добавить логирование ошибок отправки писем/инвайтов с `requestId` и понятным сообщением в UI.
- Привести ENV к одному источнику правды: `.env.example` + docs + проверка обязательных переменных на старте.

