# Универсальный парсинг выписок: улучшения и извлечение заголовков

## Цель
Сделать парсер выписок универсальным: работать с любыми форматами/языками, корректно извлекать заголовки из самой выписки и отображать их в результате парсинга.

## Основные направления улучшений
1) **Универсальное извлечение заголовков**
- Добавить слой выделения метаданных (title/statement headers, дата периода, номер счета, валюта, банк).
- Использовать гибридный подход: регулярные выражения + эвристики + ML-модель (language-agnostic) для классификации строк в начале/конце документа.
- Нормализовать заголовок (обрезка пробелов, удаление спецсимволов/неразрывных пробелов).
- Вынести заголовки в структуру результата (`statementHeader`, `period`, `account`, `currency`, `institution`).

2) **Языковая независимость**
- Автоопределение языка (fastText/langdetect) и локали; fallback — многоклассовый zero-shot на частотах биграмм.
- Таблица синонимов/шаблонов для ключевых полей (дата, сумма, дебет/кредит, назначение, контрагент) для 10+ языков.
- Регулярки с Unicode классовыми наборами, избегать ASCII-only.
- Числовой парсер с учетом разных разделителей (`,`, `.`, пробел), отрицательных сумм, валютных символов до/после числа.

3) **Робастная колонная сегментация**
- Детектировать заголовок таблицы транзакций по частоте разделителей и количеству столбцов.
- Поддерживать CSV/TSV, XLS/XLSX, PDF (текст), HTML, и plain-text копии.
- Для PDF — использовать позиционную информацию (bbox) и кластеризацию по Y, затем восстановление колонок по X (tolerance).
- Авто-выравнивание колонок по большинству строк; строки-исключения лечить через nearest-neighbor к эталонной маске.

4) **Нормализация данных транзакций**
- Поля: дата (ISO 8601), сумма, валюта, дебет/кредит флаг, назначение платежа, контрагент, документ/референс.
- Выделять `amount` и `currency` отдельно; хранить знак суммы через `isExpense`/`type`.
- Очистка назначения платежа: убрать служебный мусор (N/A, none, указано, не указано, ---).
- Токенизация и лемматизация (по определенному языку) для дальнейшей классификации.

5) **Проверки качества и auto-fix**
- Детектировать несогласованность кол-ва столбцов; авто-дополнять пустыми ячейками.
- Проверка сумм: если присутствуют итоговые строки — сверять контрольные суммы.
- Дедупликация строк по (дата, сумма, контрагент, назначение) с tolerance по пробелам/регистру.
- Лог ограничений качества: процент успешно распознанных строк, пропуски колонок, ошибки дат/сумм.

6) **Конфигурируемость**
- YAML/JSON-схема профилей банков: спец-паттерны заголовков, фиксированные позиции колонок, частые валюты.
- Возможность загрузить внешний “профиль банка” без релиза кода.
- Feature-flags для включения ML-компонент и fallback-режимов.

7) **Отображение заголовков в результате парсинга**
- Расширить API/DTO ответа парсера: `header` (сырой текст), `normalizedHeader`, `period`, `accountNumber`, `accountName`, `currency`, `institution`.
- UI: показывать заголовок/период/счет над таблицей транзакций, использовать язык выписки для подписи полей (с fallback на локаль пользователя).

## Архитектура решения
- **Входной конвейер**: детект формата → экстрактор (XLSX/PDF/CSV/TXT/HTML) → нормализация строк.
- **Метаданные**: модуль извлечения заголовков/периода/счета (regex + ML-классификатор строк).
- **Табличный парсер**: детект колонок, выравнивание, очистка строк, типизация полей.
- **Нормализация**: язык/локаль → парсинг дат/чисел/валют; очистка текста.
- **Валидация**: контрольные суммы, дедупы, лог качества.
- **Вывод**: обогащенная DTO с заголовками и транзакциями + языковая метка.

## Технологические рекомендации
- Язык/локаль: `franc`/`langdetect` + fallback на частотный анализ; кэш по домену/банку.
- Даты: `luxon`/`date-fns` с множеством шаблонов; пробовать YYYY-MM-DD, DD.MM.YYYY, MM/DD/YYYY, текстовые месяцы разных языков.
- Числа/валюты: собственный парсер на Unicode; распознавать ISO-коды и символы; нормализовать до Decimal.
- ML-классификация строк (заголовок/тело/итог): лёгкая модель на character n-grams или distil-based zero-shot; хранить веса рядом, грузить лениво.
- PDF: `pdf.js` для текста + bbox; кластеризация по линиям (tolerance ~2–3 px).
- XLS/XLSX: `xlsx` с явным указанием sheet, автообрезка пустых строк/столбцов.

## План внедрения (итеративно)
1) Добавить языко-независимый парсер дат/чисел/валют + стоп-слова для “пустых” значений.
2) Ввести модуль извлечения заголовков/метаданных и расширить DTO/ответ API.
3) Универсальный детектор колонок (CSV/TXT/PDF) с выравниванием и логом качества.
4) Поддержка банковских профилей (конфиг) и переопределений без релиза.
5) ML-классификатор строк (заголовок/итог/транзакция) как опциональный флаг.
6) Расширить UI: показывать извлечённые заголовки/период/счет/валюту на экране результатов.

## Метрики качества
- Доля распознанных строк таблицы.
- Точность распознавания сумм/дат (>99%).
- Точность извлечения заголовка/периода/валюты (>97% на бенчмарке).
- Частота fallback к ручному режиму.
- Время обработки (p95) и размер логов качества.

## Тестирование
- Набор золотых тестов с выписками разных банков/языков/форматов (PDF/XLSX/CSV/TXT/HTML).
- Позитивные/негативные кейсы: смешанные разделители, отсутствующие колонки, дубль строк, инвертированные знаки сумм, разные валюты в одной выписке.
- Регулярные регрессионные прогоны с метриками качества и снепшотами DTO.