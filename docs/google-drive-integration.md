# Интеграция с Google Drive: автоматическая синхронизация и импорт

## Цели
- Автоматически переносить банковские выписки из страницы «Хранилище» в Google Drive 1 раз в сутки.
- Разрешить импорт выписок форматов `docx`, `pdf`, `csv` напрямую из Google Drive.
- Включать/отключать интеграцию на странице «Интеграции».
- Обеспечить максимально быстрый пользовательский путь: подключение Google‑аккаунта за 1–2 минуты и быстрый старт работы.

## Область и ограничения
- Поддерживаемые типы файлов для импорта: `application/pdf`, `text/csv`, `application/vnd.openxmlformats-officedocument.wordprocessingml.document`.
- Поддерживаемые источники импорта: Google Drive (личный или корпоративный аккаунт пользователя).
- Минимальные OAuth‑скоупы: доступ только к выбранным файлам (через Google Picker) + доступ на запись в папку приложения (app folder) для автоматической синхронизации.
- Автосинхронизация 1 раз в сутки: по умолчанию в 03:00 локального времени пользователя (с возможностью изменить в настройках интеграции).

## Пользовательский сценарий (идеальный flow)
1. Пользователь открывает страницу «Интеграции» и видит карточку «Google Drive».
2. Нажимает «Подключить».
3. Открывается OAuth‑окно Google, пользователь выбирает аккаунт и подтверждает доступ.
4. После успешного подключения:
   - отображается статус «Подключено»,
   - предлагается выбрать папку для синхронизации (если не выбрана — дефолтная папка приложения).
5. Пользователь переходит в «Хранилище» и видит новый блок:
   - «Синхронизация с Google Drive» (статус + дата последнего синка),
   - кнопка «Импортировать из Google Drive».
6. Нажимает «Импортировать из Google Drive» → открывается Google Picker → выбирает файлы `docx/pdf/csv` → импорт запускается сразу.

## UI/UX требования
### Страница «Интеграции»
- Карточка Google Drive:
  - Статус: `Не подключено` / `Подключено` / `Требуется повторная авторизация`.
  - Кнопки: `Подключить`, `Отключить`, `Настроить`.
  - Настройки:
    - Папка синхронизации (Drive folder picker).
    - Время ежедневной синхронизации.
    - Переключатель «Синхронизировать выписки автоматически» (по умолчанию включено после подключения).

### Страница «Хранилище»
- Баннер/виджет:
  - Статус синхронизации: последняя дата/время.
  - Кнопка «Импортировать из Google Drive».
  - Ссылка «Настройки синхронизации» → ведёт в «Интеграции».

## Архитектура (высокоуровнево)
### Frontend
- Новая интеграция в UI «Интеграции».
- Google OAuth flow:
  - Запуск через backend endpoint (redirect URI).
  - Хранение результата в backend (tokens).
- Google Picker для импорта:
  - Открывать только если интеграция подключена.
  - Фильтры по MIME.

### Backend
#### Новые сущности
- `integrations` (таблица):
  - `id`, `workspace_id`, `provider` (`google_drive`), `status`, `scopes`, `created_at`, `updated_at`
- `integration_tokens`:
  - `integration_id`, `access_token`, `refresh_token`, `expires_at`
- `drive_settings`:
  - `integration_id`, `folder_id`, `sync_enabled`, `sync_time`, `last_sync_at`

#### Новые эндпоинты
- `GET /integrations/google-drive/connect` → редирект на Google OAuth.
- `GET /integrations/google-drive/callback` → получение `code` и сохранение токенов.
- `POST /integrations/google-drive/disconnect`
- `GET /integrations/google-drive/status`
- `POST /integrations/google-drive/settings` (папка, время, включение).
- `POST /integrations/google-drive/import` → импорт выбранных файлов.
- `POST /integrations/google-drive/sync` → ручной запуск синка.

#### Периодическая синхронизация
- CRON job (1 раз в сутки):
  - Для каждого workspace с включенной интеграцией:
    - Собрать список новых выписок из «Хранилища» (созданных после `last_sync_at`).
    - Загрузить файлы в выбранную папку Google Drive.
    - Обновить `last_sync_at`.

## Требования по безопасности
- Токены хранить зашифрованными.
- Минимальные OAuth‑скоупы.
- Запрет на доступ к Drive без явного подключения.
- Возможность мгновенного отключения (удаление токенов).

## Миграции (база данных)
- Добавить таблицы для интеграций, токенов и настроек.
- Индексы по `workspace_id` и `integration_id`.

## Логирование и мониторинг
- Логи успешной синхронизации (workspace, количество файлов).
- Ошибки OAuth / refresh token / upload.
- Метрики: количество подключений, успешных импортов, среднее время импорта.

## Ошибки и edge‑cases
- Истёк refresh token → статус «Нужна повторная авторизация».
- Неверный MIME → показать ошибку «Формат не поддерживается».
- Ограничение по размеру файла → показать точное сообщение.
- Конфликт имен файлов → переименовывать с суффиксом времени.

## План реализации
1. Добавить модели/миграции интеграций и токенов.
2. Реализовать OAuth flow Google Drive.
3. Добавить UI «Интеграции» и переключатель.
4. Реализовать Google Picker импорт.
5. Реализовать ежедневный sync job + ручной sync.
6. Протестировать flows (happy path + ошибки).

## UX‑критерии качества
- Подключение за ≤ 60 секунд.
- Импорт первого файла ≤ 30 секунд после выбора.
- Минимум 1 экран между «Подключить» и «Импортировать».

