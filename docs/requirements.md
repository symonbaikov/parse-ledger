ТЕХНИЧЕСКОЕ ЗАДАНИЕ

на разработку системы загрузки и автоматической обработки банковских выписок

⸻

1. ОБЩИЕ ПОЛОЖЕНИЯ

1.1. Наименование системы

Система автоматической загрузки и обработки банковских выписок (условное рабочее название: FinFlow).

1.2. Цель разработки

Создание веб-приложения и автоматизированной системы для:
	•	Загрузки банковских выписок в различных форматах (PDF, Excel, сканированные документы)
	•	Автоматического распознавания банковских операций
	•	Структурирования данных в формате Google Sheets
	•	Формирования финансовых отчётов
	•	Автоматической отправки отчётов в Telegram
	•	Централизованного хранения и анализа операций по всем банковским счетам компании

1.3. Основание для разработки

Необходимость автоматизации процесса обработки банковских выписок с функционалом, аналогичным странице import/statement сервиса FinPeak, но с возможностью:
	•	полной кастомизации под требования заказчика;
	•	расширения логики учёта;
	•	глубокой интеграции с существующими бизнес-процессами и Google-экосистемой.

⸻

2. ТРЕБОВАНИЯ К ВХОДНЫМ ДАННЫМ

2.1. Поддерживаемые форматы банковских выписок

2.1.1. PDF-выписки банка Bereke Bank (новый формат)
	•	Выписки по счёту формата KZ47914042204KZ039LY
	•	Структура таблицы включает следующие колонки:
	•	Дата операции
	•	Номер документа
	•	Наименование контрагента
	•	БИН/номер счёта контрагента
	•	Реквизиты банка контрагента
	•	Дебет
	•	Кредит
	•	Назначение платежа
	•	Итоговые данные: обороты, остаток на начало и конец периода

2.1.2. PDF-выписки банка Bereke Bank (старый формат)
	•	Поддержка двух версий формата выписок
	•	Референсные файлы:
	•	statement-316.pdf,
	•	statement-317.pdf,
	•	выписки по счету KZ17722S000023921191
	•	Особенности:
	•	Вариативная табличная структура
	•	Различное количество колонок в зависимости от версии
	•	Возможное отсутствие отдельных колонок
	•	Автоматическое определение структуры таблицы и маппинг колонок

2.1.3. PDF-выписки банка Kaspi Bank
	•	Архитектура системы должна позволять добавление поддержки форматов Kaspi без изменения базового ядра
	•	Поддержка нескольких форматов Kaspi при появлении примеров от заказчика

2.1.4. Файлы Excel и CSV
	•	Поддержка форматов XLS, XLSX
	•	Поддержка CSV-файлов с автоматическим определением разделителей (запятая, точка с запятой, табуляция)

2.1.5. Сканированные документы (опционально)
	•	Форматы JPG, PNG
	•	Распознавание текста через OCR-технологии
	•	Возможна последующая адаптация под реальные примеры заказчика

⸻

3. ФУНКЦИОНАЛЬНЫЕ ТРЕБОВАНИЯ

3.1. Веб-интерфейс загрузки документов

3.1.1. Страница загрузки файлов /upload
	•	Выпадающий список для выбора:
	•	целевого Google Sheet,
	•	проекта / кошелька / филиала (по согласованию).
	•	Область drag-and-drop для загрузки файлов
	•	Возможность одновременной загрузки до 2 файлов
	•	Индикация прогресса загрузки
	•	Валидация форматов файлов на клиенте
	•	Отображение статуса обработки:
	•	загружено,
	•	в обработке,
	•	обработано,
	•	ошибка.

3.1.2. Поддерживаемые форматы файлов
	•	PDF (приоритетный формат)
	•	XLS / XLSX
	•	CSV
	•	JPG / PNG (при включённом OCR-модуле)

3.2. Загрузка через Telegram (опционально, последующая фаза)

3.2.1. Функционал Telegram-бота
	•	Приём PDF-выписок от пользователя
	•	Автоматическая обработка полученных документов
	•	Отправка результатов обработки в административную группу
	•	Уведомления об ошибках обработки
	•	Возможность вручную запросить отчёт за день/месяц

⸻

4. МОДУЛЬ РАСПОЗНАВАНИЯ И РЕДАКТИРОВАНИЯ ДАННЫХ

4.1. Автоматическое распознавание

4.1.1. Процесс обработки
	•	Извлечение табличных данных из PDF
	•	Преобразование в структурированный JSON
	•	Автоматическая классификация операций (приход/расход)
	•	Нормализация чисел:
	•	замена запятой на точку,
	•	удаление разделителей тысяч,
	•	приведение к числовым типам.

4.1.2. Распознаваемые поля
	•	Дата операции
	•	Наименование контрагента
	•	БИН контрагента
	•	Номер счёта контрагента
	•	Реквизиты банка контрагента
	•	Сумма по дебету
	•	Сумма по кредиту
	•	Назначение платежа
	•	Валюта (если присутствует)
	•	Номер документа (при наличии)

4.2. Интерфейс редактирования данных

4.2.1. Возможности редактирования
	•	Просмотр распознанных данных в табличном виде
	•	Удаление отдельных записей
	•	Редактирование значений полей
	•	Выбор категории операции из справочника
	•	Указание филиала
	•	Выбор кошелька (счёта)
	•	Добавление комментариев
	•	Массовое изменение атрибутов по выделенным строкам

⸻

5. МОДУЛЬ АВТОМАТИЧЕСКОЙ КЛАССИФИКАЦИИ

5.1. Логика распределения данных

5.1.1. Автоматическое определение
	•	Тип операции (приход/расход) по значениям дебета/кредита
	•	Категория расхода/дохода по правилам (по контрагенту, назначению)
	•	Контрагент операции
	•	Статья учёта
	•	Тип платежа
	•	Филиал
	•	Валюта операции
	•	Обменный курс (если присутствует)

5.1.2. Примеры классификации
	•	Платёж 385 120,00 тенге → категория «Приход»
	•	Платёж 100 000,00 тенге → категория «Зарплаты сотрудникам» (расход)
	•	Платёж с назначением, содержащим шаблон «Kaspi Red» → категория «Платежи Kaspi Red»

⸻

6. ИНТЕГРАЦИЯ С GOOGLE SHEETS

6.1. Структура данных в таблице

6.1.1. Автоматически заполняемые колонки
	•	Месяц (текстовое представление)
	•	Год
	•	Месяц (числовое представление)
	•	Дата операции
	•	Сумма в тенге
	•	Сумма в альтернативной валюте
	•	Код валюты
	•	Обменный курс
	•	Кошелёк (счёт)
	•	Филиал
	•	Статья учёта
	•	Контрагент
	•	Назначение платежа
	•	Дополнительные комментарии
	•	Вид деятельности
	•	Тип операции (платёж/поступление)
	•	Курсы USD и RUB (при наличии)

6.1.2. Требования к интеграции
	•	Полная идентичность структуре текущей таблицы заказчика
	•	Сохранение существующего форматирования
	•	Добавление данных без перезаписи существующих строк
	•	Обработка ошибок Google Sheets API (повторные попытки, логирование)

⸻

7. СИСТЕМА АВТОМАТИЧЕСКИХ ОТЧЁТОВ

7.1. Ежедневные отчёты в Telegram
	•	Общая сумма поступлений и количество операций прихода
	•	Общая сумма расходов и количество операций расхода
	•	Топ контрагентов по приходам
	•	Топ категорий по расходам
	•	Итог дня: разница приход–расход, остаток (при наличии данных)

7.2. Месячные отчёты
	•	Динамика поступлений и расходов по дням
	•	Распределение по категориям
	•	Распределение по контрагентам
	•	Сравнение с предыдущим периодом
	•	Возможность ручного запроса отчёта за произвольный период

⸻

8. АДМИНИСТРАТИВНАЯ ПАНЕЛЬ
	•	Журнал загрузок выписок (фильтры, поиск)
	•	История обработки файлов и статусы
	•	Просмотр и экспорт отчётов (Excel, CSV)
	•	Просмотр и повторная обработка ошибочных файлов
	•	Управление правилами парсинга (ParsingRule)

⸻

9. МОДУЛЬ OCR (ОПЦИОНАЛЬНЫЙ)

Как в исходном варианте: Tesseract / Google Vision API, предобработка изображений, извлечение таблиц, передача в основной модуль.

⸻

10. ТЕХНИЧЕСКИЕ ТРЕБОВАНИЯ

10.1. Стек технологий
	•	Frontend: React / Next.js, MUI / Ant Design, Redux Toolkit или Context API
	•	Backend: Node.js, NestJS (предпочтительно) или Express
	•	БД: PostgreSQL
	•	PDF: pdf-parse / pdf-lib или аналог
	•	OCR (опция): Tesseract.js / Google Vision API
	•	Интеграции: Telegram Bot API, Google Sheets API, Google Drive API

10.2. Развёртывание и производительность
	•	Frontend: Vercel / Netlify
	•	Backend: Render / Railway / AWS
	•	БД: облачный PostgreSQL
	•	Обработка одного PDF — до 30 секунд
	•	До 5 параллельных обработок
	•	Доступность — 99.5%

10.3. Общая архитектура системы

Архитектура многослойная:
	1.	Клиентский слой (Frontend)
	•	Веб-UI загрузки файлов, просмотра транзакций, отчётов.
	•	Работает только через REST API.
	•	Использует access_token (JWT) для авторизации.
	2.	API-слой (Backend / API Gateway)
	•	Принимает запросы фронта и Telegram-бота.
	•	Обрабатывает аутентификацию/авторизацию.
	•	Реализует REST API: /auth, /statements, /transactions, /reports, /telegram, /google-sheets.
	•	Делегирует бизнес-логику в сервисный слой.
	3.	Сервисный / доменный слой
	•	Парсинг и нормализация выписок.
	•	Классификация операций (категории, кошельки, филиалы).
	•	Логика интеграции с Google Sheets.
	•	Генерация отчётов.
	4.	Слой интеграций
	•	Клиенты для Google Sheets, Google Drive, Telegram.
	•	Ретраи при временных ошибках (сетевые сбои, rate limits).
	5.	Слой хранения данных
	•	PostgreSQL: таблицы users, statements, transactions, categories, wallets, branches, google_sheets, telegram_reports, parsing_rules.
	•	Миграции БД через миграционный инструмент (например, Prisma / TypeORM / Knex).
	6.	Фоновые задачи (workers)
	•	Асинхронный парсинг файлов, генерация отчётов, отправка Telegram.
	•	Очереди задач (BullMQ / Redis — по согласованию).
	7.	Telegram-слой
	•	Либо часть backend, либо отдельный сервис.
	•	Обрабатывает команды, загрузку файлов, отправку отчётов.

10.4. Observability, логирование и мониторинг
	1.	Логирование
	•	Структурированные логи (JSON) с полями:
	•	timestamp, level, service, user_id, statement_id, correlation_id, message, details.
	•	Логируются ключевые события:
	•	загрузка файла,
	•	старт/конец парсинга,
	•	ошибки,
	•	генерация и отправка отчётов.
	2.	Метрики
	•	Время обработки файла
	•	Кол-во успешно обработанных и упавших выписок
	•	Кол-во отправленных Telegram-отчётов
	•	Время ответа API
	3.	Трейсинг (по согласованию)
	•	Поддержка OpenTelemetry / Jaeger.
	•	Корреляция логов и запросов по correlation_id.
	4.	Алерты (по согласованию)
	•	Напоминания/уведомления при:
	•	росте ошибок парсинга,
	•	недоступности интеграций,
	•	деградации времени ответа.
	5.	Аудит-лог
	•	Запись действий пользователей:
	•	загрузка / удаление выписок,
	•	изменение категорий, кошельков, филиалов,
	•	ручные запуски отчётов.

⸻

11. ПЛАН РАЗРАБОТКИ

(этапы 1–4, как у тебя было: базовый функционал → финализация логики → Telegram-интеграция → тесты и документация; можно оставить без изменений.)

⸻

12. ОЖИДАЕМЫЕ РЕЗУЛЬТАТЫ

(как в твоём тексте: функциональные, экономические, технические преимущества.)

⸻

13. API, JWT, ИДЕМПОТЕНТНОСТЬ И СУЩНОСТИ

13.1. Архитектура API
	•	RESTful, JSON, UTF-8
	•	Версионирование: /api/v1
	•	Базовые URL (пример):
	•	https://api.finflow.app/api/v1 (prod)
	•	https://dev-api.finflow.app/api/v1 (dev)

13.2. JWT и авторизация
	•	Авторизация по Authorization: Bearer {access_token}
	•	Поток:
	•	/auth/register — регистрация
	•	/auth/login — логин (email + password)
	•	/auth/refresh — получение нового access_token по refresh_token
	•	/auth/logout — деактивация refresh_token (по согласованию)

Access token:
	•	Алгоритм: HS256 или RS256
	•	Срок: ~1 час
	•	Payload:
	•	sub — user_id
	•	email
	•	role
	•	iat, exp
	•	jti — id токена

Refresh token:
	•	Срок: ~30 дней
	•	Payload:
	•	sub — user_id
	•	type: "refresh"
	•	iat, exp
	•	jti

Требования:
	•	Хранение секретов в защищённых переменных окружения
	•	Только HTTPS
	•	Возможность ревокации refresh токенов
	•	Rate limiting на /auth/login

13.3. Идемпотентность

Общий принцип: повторный запрос с теми же входными данными не должен создавать дубликаты.
	1.	Загрузка выписок (POST /statements/upload)
	•	Вычисляется file_hash (SHA-256 от бинарного содержимого).
	•	При наличии в БД записи с тем же file_hash + account_number + период:
	•	новая запись не создаётся,
	•	возвращается существующий Statement.
	•	Дополнительно: поддержка заголовка Idempotency-Key: {uuid},
который связывается с результатом первого успешного запроса.
	2.	Генерация и отправка отчётов
	•	Ключ идемпотентности: (user_id, report_type, report_date).
	•	Повторный запрос отчёта за тот же день/месяц:
	•	переиспользует уже сгенерированный отчёт
	•	либо возвращает статус уже отправленного TelegramReport.
	3.	Webhooks (если будут)
	•	Ключ: (event, external_id/statement_id, timestamp или sequence)
	•	Повторные вызовы не должны дублировать операции.
	4.	Массовые операции (POST /transactions/bulk-update)
	•	Рекомендуется поддержка Idempotency-Key для крупных операций.

13.4. Основные сущности и связи в БД

(как в твоём тексте: User, Statement, Transaction, Category, Branch, Wallet, GoogleSheet, TelegramReport, ParsingRule, с описанными полями и связями. Схема связей в кратком виде:)
	•	User 1—N Statements
	•	Statement 1—N Transactions
	•	User 1—N Categories / Branches / Wallets / GoogleSheets / TelegramReports
	•	Category / Branch / Wallet 1—N Transactions

13.5. Основные API-эндпоинты

Кратко:
	•	/auth/* — регистрация, логин, refresh, logout
	•	/statements/* — загрузка, список, детали, reprocess, delete
	•	/transactions/* — список, детали, обновление, bulk-update, delete
	•	/categories/* — CRUD категорий
	•	/google-sheets/* — подключение/синхронизация Google Sheets
	•	/reports/* — daily/monthly/custom, экспорт
	•	/telegram/* — connect, send-report, история отправок

(Детализация по каждому endpoint — как у тебя в прошлой версии, можно закрыть Swagger/OpenAPI.)

13.6. Ошибки и коды ответов
	•	200, 201, 204, 400, 401, 403, 404, 422, 429, 500
	•	Единый формат ошибки:
    {
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "Описание ошибки",
    "details": { "field": "email" }
  }
}


13.7. Webhooks
	•	События: statement.uploaded, statement.processed, statement.failed, report.generated, и т.п.
	•	Формат payload — как в предыдущей версии ТЗ.