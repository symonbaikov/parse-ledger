# Хранилище: must have / nice to have

## Must have
- [x] Надёжное хранение файлов: единый uploads-дир, запрет авто-удаления оригинала после записи в БД; health-check доступности диска и алёрт при EACCES/ENOENT.
- [x] Предпросмотр/скачивание без 404: fallback на `fileData` из БД, повторное восстановление файла на диск при отсутствии; метрика ошибок view/download и прогон smoke-теста в CI.
- [x] Файловая консистентность: проверка хеша при чтении, флаг `hasFileOnDisk/hasFileInDb` в API, действие «восстановить файл» из БД.
- [ ] Статусы хранилища: явный статус “нет файла на диске/в БД” на UI с CTA «восстановить/перезагрузить» (бекенд: hasFileOnDisk/hasFileInDb/fileAvailability + restore API; фронт pending).
- [x] Защита ссылок: ревокация/истечение shared links, логирование access_count/last_accessed, маскирование токенов в логах.
- [ ] Права доступа: единый ACL (owner/manager/editor/viewer/downloader), проверка сроков/reshare; запрет шаринга без `canReshare`.
- [x] Массовые операции: bulk удаление/скачивание/шаринг выбранных файлов; подтверждения/undo (бекенд: bulk delete + ссылки для download; share/undo на фронт).
- [x] Поиск/фильтры: имя, банк, статус файла (есть/нет), дата загрузки, тег/папка; быстрый фильтр «только мои», «поделились со мной» (бекенд фильтры search/bank/availability/scope; теги/папки фронт).
- [x] Транзакции/метаданные в деталях: пагинация, экспорт транзакций в CSV/XLSX, подсветка несоответствий баланса (бекенд CSV export + баланс mismatch флаг; фронт подсветка pending).

## Nice to have
- [x] Папки/теги + drag-n-drop между папками; сохранённые фильтры/виды.  
  - Этап 1: схема Folder/Tag, миграция, API CRUD, назначение тегов/папок при загрузке. (выполнено: Tag + statement_tags, Folder + folder_id, API CRUD тегов/папок, фильтры tagIds/folderId, saved views API)  
  - Этап 2: фронт — дерево папок и чипы тегов, dnd перемещение, сохранённые виды (query + сортировка) в профиле пользователя. (выполнено)
- Версионирование файлов: история перезагрузок, сравнение версий, откат.  
  - Этап 1: таблица file_versions (blob/hash/size/createdBy), API загрузки новой версии и получения списка.  
  - Этап 2: UI таймлайн, дифф по хешам/разнице транзакций, откат создаёт новую версию, пометка «активная версия».
- Корзина: мягкое удаление с автоочисткой по TTL, восстановление по одному клику.  
  - Этап 1: флаг deleted_at, скрытие из основного списка, RESTORE/DELETE endpoints, защита шаринга удалённых.  
  - Этап 2: UI вкладка «Корзина», массовое восстановление/очистка, TTL джоб на очистку, предупреждения о скором удалении.
- Наблюдаемость: дешборд по ошибкам preview/download, hit-rate по диску/БД, алёрты на рост 404/500.  
  - Этап 1: метрики preview/download (latency, errors, source=disk|db|restored), алёрты на 404/500.  
  - Этап 2: Grafana дашборд, cron smoke-тест `storage verify`, отчёт по восстановленным/битым файлам.
- Интеграции: автосинк с облаками (GDrive/Dropbox/S3) как внешние стораджи, выбор при загрузке.  
  - Этап 1: абстракция StorageProvider, коннекторы GDrive/Dropbox/S3, выбор провайдера при загрузке/в настройках.  
  - Этап 2: мониторинг статуса синка, retries/DLQ, ручной ребилд ссылок/инвалидация при ошибках.
- Уведомления: при шаринге, скачивании по ссылке, истечении прав/ссылок, доступно в Telegram/Email.  
  - Этап 1: event bus на share/create/download, шаблоны email/telegram, настройка уровня уведомлений.  
  - Этап 2: digest/мьюты, уведомление об истечении прав/ссылок, SLA на доставку, unsubscribe на пользователя/workspace.
- Security: link throttling/captcha при bruteforce пароля, опция одноразового скачивания, водяные знаки в превью.  
  - Этап 1: rate-limit по token, captcha после N фэйлов, флаг single-use link.  
  - Этап 2: водяные знаки (email/token/time) в превью, опциональный device binding, лог попыток с IP/UA.
- API/CLI: `storage verify` для фоновой проверки доступности файлов, `storage repair` для восстановления дисковых копий из БД.  
  - Этап 1: cron/CLI verify — обход файлов, сравнение хешей, отчёт о missing/mismatch в лог/метрики.  
  - Этап 2: repair — авто-восстановление из DB/дубликатов, summary в UI, вебхук/уведомление об инцидентах.
