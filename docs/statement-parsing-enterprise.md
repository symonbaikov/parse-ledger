# Парсинг выписок: шаги до enterprise-уровня

## Что есть сейчас (по коду)
- Базовые парсеры для Bereke (старый/новый), Kaspi и generic PDF/Excel/CSV (`backend/src/modules/parsing/parsers/*`), выбор по эвристикам текста в `parser-factory.service.ts`.
- Извлечение текста/таблиц через python `pdfplumber` (`common/utils/pdf-parser.util.ts`), с кэшем на файл.
- Постобработка: классификация транзакций и запись в БД в `StatementProcessingService`, простое объединение/дедуп по сигнатуре в `pdf-table.helper.ts`.
- AI вспомогательные шаги (Gemini) для извлечения/валидации, но без гарантированного качества и без телеметрии.
- Есть зачатки конфигурации правил в БД (`ParsingRulesService`, `parsing-rule.entity.ts`), но они не используются в пайплайне.

## Ключевые пробелы
- Детекция банка/формата держится на строковых проверках; нет версии формата, fallback цепочки и доверенной матрицы покрытий.
- Валидация слабая: нет сверки балансов и периодов, нет строгой схемы транзакции/метаданных, нет обязательных полей по банкам.
- Idempotency ограничена: повторные загрузки и дубли строк ловятся только примитивной сигнатурой, нет глобальных ключей/хешей на запись.
- AI используется без SLO: нет статистики точности, фоллбэков, лимитов и тестового набора для регрессий.
- Наблюдаемость ограничена: логи собираются в `parsingDetails`, но нет метрик, трассировок и алёртов по ошибкам/долгим парсам.
- Отсутствует системный набор “золотых” выписок и контрактные тесты на парсеры/регрессии.

## Предложения (фокус на ближайшие этапы)

### P0 — Надёжность и детерминизм
- Ввести единый контракт ParsedStatement/Transaction (class-validator или zod) с жёсткой схемой: обязательные даты, валюта, знаки сумм, длины БИН/IBAN, нормализация кодировок. Отбрасывать/логировать строки, не прошедшие схему.
- Сверка баланса: проверять `balanceStart + Σcredit - Σdebit == balanceEnd` в допустимом ε; расхождения помечать как `parsingDetails.warnings` и блокировать статус `validated`.
- Усилить idempotency: хеш файла уже есть, добавить уникальный ключ на (statement_id, signature) в транзакциях и отдельный хеш строки (дата+сумма+контрагент+назначение) для сквозной дедупликации.
- Версионирование парсеров: фиксировать `parserVersion` в `parsingDetails`, хранить мапу “банк/формат -> версия/валидаторы” через `parsing_rules` и использовать её при выборе парсера.
- Строгая цепочка выбора парсера: детектор → попытка формата по правилам → специализированный парсер → generic → AI-only. Логировать причины перехода между этапами.

### P1 — Observability, контроль качества и DX
- Метрики/трейсинг: время извлечения текста, время детекта банка, время парсинга, доля AI-вызовов, ошибки pdfplumber; публиковать в Prometheus + тайминг/лейблы в `parsingDetails`.
- Логирование в JSON со сквозным request/statement id; алёрты на процент ошибок >X% за окно и на хвостовые латентности.
- Золотой датасет: собрать по 10–20 выписок на банк/формат (PDF, XLSX, CSV), хранить эталоны ParsedStatement, прогонять в CI контрактные тесты и визуальные диффы (в суммах/датах/балансе).
- Инструменты разработчика: CLI `parse:debug <file>` с выводом детектора, колонок, промежуточных таблиц; снапшоты таблиц из pdfplumber для удобной разметки.
- Фича-флаги AI: явно логировать “AI on/off”, лимит concurrency/таймаутов, счётчики успешных/пустых ответов, fallback на rule-based.

### P2 — Расширение покрытия и устойчивости
- Банк/формат coverage: добавить сигнатуры и отдельные парсеры для Halyk, Freedom, Jusan, Форте; у каждого — форматы v1/v2 с правилами из `parsing_rules` (мэппинг столбцов, регулярки дат/сумм).
- Обработка изображений/сканов: интегрировать OCR (tesseract/vision API) как шаг до pdfplumber, с кешированием распознанного текста.
- Мультивалютность: хранить валюту строки + курс/сумму в валюте операции; конвертация в валюту выписки с фиксацией источника курса.
- Защита от деградаций: очередь парсинга с DLQ, повтор с backoff при ошибках pdfplumber/AI, автоматическое отключение проблемного парсера по метрикам ошибок.
- Безопасность данных: маскирование БИН/IBAN в логах и при отправке в AI; конфигurable redaction для PII.

### P3 — Расширение возможностей
- Автоматическое обогащение: подтягивать классификаторы КНП/назначений, геотеги по БИК, сопоставление контрагента с ЕГРЮЛ/ЕГРПО через кэшируемые справочники.
- Нормализация валют: хранить операции в валюте транзакции и базовой валюте счёта, фиксируя источник курса (НБ РК/ЦБР/костом), с алёртом при разрыве баланса из-за курса.
- Улучшение дедупа: глобальный хеш транзакции + soft-merge по документу+сумме в окне даты, с журналом объединений.
- Self-heal парсеров: логировать “непрочитанные” строки/столбцы и собирать их в датасет для semi-auto разметки колонок, быстрых hotfix правил.
- API/CLI для re-parse: переобработка выписки с новой версией парсера/правил, сравнение результатов (diff метаданных/сумм/транзакций) и откат при регрессии.
- Стриминг больших файлов: парсинг чанками с буферизацией транзакций, чтобы не держать весь PDF/CSV в памяти.

### Быстрые wins (можно брать первыми)
- Добавить балансную сверку и статус `validated`, который ставится только при прохождении чеков.
- Подключить Prometheus метрики в `StatementProcessingService` (таймеры и error counters).
- Завести минимальный набор эталонных файлов и тест `yarn backend test parsing --golden`.
- Записывать `parserVersion` и `formatVersion` в `parsingDetails` и таблицу `statements` для отслеживания регрессий.

## Стадии реализации
- Этап 1: Надёжность ядра
  - Ввести строгую схему ParsedStatement/Transaction, баланс-чек, parserVersion/formatVersion в деталях.
  - Жёсткая цепочка выбора парсера + предупреждения/ошибки с причинами перехода.
  - Метрики времени/ошибок в Prometheus, алёрты на рост ошибок и хвосты латентности.
- Этап 2: Контроль качества и DX
  - Минимальный golden-set (10–20 файлов), контрактные тесты и golden-тест в CI.
  - CLI `parse:debug` с промежуточными таблицами и детектором; снапшоты для разметки колонок.
  - Фича-флаги AI, лимиты по таймауту/конкурентности, счётчики успешных/пустых ответов.
- Этап 3: Расширение покрытия
  - Добавить парсеры/правила для Halyk/Freedom/Jusan/Forte, мультивалютные поля и хеши строк для дедупа.
  - OCR шаг для сканов (tesseract/vision API) с кешем текста.
  - Очередь парсинга с DLQ и auto-disable проблемных парсеров по метрикам ошибок.
- Этап 4: Безопасность и эксплуатация
  - Маскирование БИН/IBAN/PII в логах и при вызове AI.
  - Регулярные регрессионные прогоны на golden-set + отчёт по отклонениям.
  - Документация SLO (успешные парсы, латентность) и playbooks на инциденты.
- Этап 5: Расширение возможностей
  - Ввести обогащение КНП/контрагентов, дву-валютные суммы и контроль курс-расхождений.
  - Улучшить дедуп (глобальный хеш + soft-merge) и self-heal: сбор непрочитанных строк/колонок, полуавтоматическая разметка.
  - Добавить re-parse API/CLI с диффами и стриминговый парсинг для больших файлов.
