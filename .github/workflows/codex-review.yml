name: Codex Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

permissions:
  contents: read
  pull-requests: write
  checks: write
  issues: write

concurrency:
  group: codex-review-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  codex-review:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    outputs:
      review_output: ${{ steps.parse.outputs.summary }}
      blocker_count: ${{ steps.parse.outputs.blockers }}
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          ref: refs/pull/${{ github.event.pull_request.number }}/merge
          fetch-depth: 0
          persist-credentials: false

      - name: Fetch PR refs
        run: |
          git fetch --no-tags origin \
            ${{ github.event.pull_request.base.ref }} \
            +refs/pull/${{ github.event.pull_request.number }}/head

      - name: Run Codex review
        id: run_codex
        uses: openai/codex-action@v1
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          safety-strategy: drop-sudo
          sandbox: workspace-write
          prompt-file: .github/prompts/codex-review.md
          output-file: codex-output.json
          output-schema: |
            {
              "type": "object",
              "properties": {
                "summary": {
                  "type": "array",
                  "items": { "type": "string" }
                },
                "findings": {
                  "type": "array",
                  "items": {
                    "type": "object",
                    "properties": {
                      "severity": { "type": "string", "enum": ["blocker", "major", "minor", "question"] },
                      "file": { "type": "string" },
                      "line": { "type": "number" },
                      "rationale": { "type": "string" },
                      "suggested_fix": { "type": "string" }
                    },
                    "required": ["severity", "file", "line", "rationale", "suggested_fix"]
                  }
                }
              },
              "required": ["summary", "findings"]
            }
          codex-args: '["--verbose", "--max-iterations", "5"]'

      - name: Summarize Codex findings
        id: parse
        run: |
          if [ ! -f codex-output.json ]; then
            echo "summary=Codex produced no output." >> "$GITHUB_OUTPUT"
            echo "blockers=0" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          blockers=$(jq '[.findings[] | select(.severity=="blocker")] | length' codex-output.json)

          summary=$(jq -r '["## Codex Review", "", "### Summary"] + (.summary | map("- " + .)) + ["", "### Findings"] + (if (.findings | length) == 0 then ["- No findings."] else (.findings | map("- **" + .severity + "** `" + .file + ":" + (.line|tostring) + "` " + .rationale + (if .suggested_fix != "" then " — " + .suggested_fix else "" end))) end) | join("\n")' codex-output.json)

          echo "summary<<EOF" >> "$GITHUB_OUTPUT"
          echo "$summary" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"
          echo "blockers=$blockers" >> "$GITHUB_OUTPUT"

      - name: Publish Codex check and comment
        uses: actions/github-script@v7
        env:
          CODEX_SUMMARY: ${{ steps.parse.outputs.summary }}
          CODEX_BLOCKERS: ${{ steps.parse.outputs.blockers }}
        with:
          github-token: ${{ github.token }}
          script: |
            const fs = require('fs');
            const summary = process.env.CODEX_SUMMARY || '';
            const blockers = Number(process.env.CODEX_BLOCKERS || '0');

            if (!summary) {
              core.info('No Codex summary to publish.');
              return;
            }

            let findings = [];
            if (fs.existsSync('codex-output.json')) {
              try {
                const raw = fs.readFileSync('codex-output.json', 'utf8');
                const parsed = JSON.parse(raw);
                findings = Array.isArray(parsed.findings) ? parsed.findings : [];
              } catch (err) {
                core.warning(`Failed to parse codex-output.json: ${err.message}`);
              }
            }

            const annotations = findings.slice(0, 50).map((finding) => {
              const line = Number(finding.line) || 1;
              let annotationLevel = 'notice';
              if (finding.severity === 'blocker') annotationLevel = 'failure';
              if (finding.severity === 'major') annotationLevel = 'warning';

              const message = `${finding.rationale}${finding.suggested_fix ? ' — ' + finding.suggested_fix : ''}`;

              return {
                path: finding.file,
                start_line: line,
                end_line: line,
                annotation_level: annotationLevel,
                message,
              };
            });

            const conclusion = blockers > 0 ? 'failure' : 'success';
            const output = {
              title: 'Codex Code Review',
              summary,
            };
            if (annotations.length) {
              output.annotations = annotations;
            }

            await github.rest.checks.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: 'Codex Code Review',
              head_sha: context.payload.pull_request.head.sha,
              status: 'completed',
              conclusion,
              output,
            });

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: summary,
            });

  codex-gate:
    runs-on: ubuntu-latest
    needs: codex-review
    if: always()
    steps:
      - name: Fail on blocker findings
        run: |
          count="${{ needs.codex-review.outputs.blocker_count }}"
          if [ -z "$count" ]; then
            echo "No Codex output; skipping gate."
            exit 0
          fi
          if [ "$count" -gt 0 ]; then
            echo "Blocker findings: $count"
            exit 1
          fi
          echo "No blocker findings."
